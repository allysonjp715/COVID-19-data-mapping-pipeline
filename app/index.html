<!DOCTYPE html>
<html lang="en">
<head>
  <title>Novel Coronavirus (COVID-19)</title>
  <meta charset="utf-8">
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
  <script async defer src="https://api.mapbox.com/mapbox-gl-js/v1.8.1/mapbox-gl.js" onload="initMap()"></script>
  <link rel="stylesheet" type="text/css" href="css/fonts.css" />
  <!-- <link rel="stylesheet" type="text/css" href="css/styles.css?b" /> -->
  <link rel="stylesheet" type="text/css" href="css/styles-new.css?b" />
</head>
<body>
  <div class="modal-wrapper" id="modal">
    <div class="modal-backdrop"></div>
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title">Contributors</div>
        <div class="modal-cancel"><img src="img/close-icon.svg" width="20" height="20" alt="Close" /></div>
      </div>
      <div class="modal-body">
        <ul>
      		<li>Isha Berry, <a href="mailto:isha.berry@mail.utoronto.ca">isha.berry@mail.utoronto.ca</a></li>
          <li>John Brownstein, <a href="mailto:John.Brownstein@childrens.harvard.edu">John.Brownstein@childrens.harvard.edu</a></li>
          <li>Emily Cohn, <a href="mailto:Emily.Cohn@childrens.harvard.edu">Emily.Cohn@childrens.harvard.edu</a></li>
          <li>Lauren Goodwin, <a href="mailto:Lauren.Goodwin@childrens.harvard.edu">Lauren.Goodwin@childrens.harvard.edu</a></li>
          <li>Bernardo Gutierrez, <a href="mailto:bernardo.gutierrez@zoo.ox.ac.uk">bernardo.gutierrez@zoo.ox.ac.uk</a></li>
          <li>Sarah Hill, <a href="mailto:sarah.hill@zoo.ox.ac.uk">sarah.hill@zoo.ox.ac.uk</a></li>
          <li>Erin Hulland, <a href="mailto:ehulland@uw.edu">ehulland@uw.edu</a></li>
          <li>Moritz Kraemer, <a href="mailto:moritz.kraemer@zoo.ox.ac.uk">moritz.kraemer@zoo.ox.ac.uk</a></li>
      		<li>Anastasia Lambrou, <a href="mailto:anastasia.lambrou@jhu.edu">anastasia.lambrou@jhu.edu</a></li>
          <li>Sabrina Li, <a href="mailto:sabrina.li@ouce.ox.ac.uk">sabrina.li@ouce.ox.ac.uk</a></li>
          <li>Alyssa Loskill, <a href="mailto:aloskill@bu.edu">aloskill@bu.edu</a></li>
          <li>Sumiko Mekaru, <a href="mailto:srmekaru@gmail.com">srmekaru@gmail.com</a></li>
          <li>Julia Morgan, <a href="mailto:morgaj5@uw.edu">morgaj5@uw.edu</a></li>
          <li>Katelynn O'Brien, <a href="mailto:katelynn.obrien@childrens.harvard.edu">katelynn.obrien@childrens.harvard.edu</a></li>
          <li>David Pigott, <a href="mailto:pigottdm@uw.edu">pigottdm@uw.edu</a></li>
      		<li>Oliver Pybus, <a href="mailto:oliver.pybus@zoo.ox.ac.uk">oliver.pybus@zoo.ox.ac.uk</a></li>
          <li>Sam Scarpino, <a href="mailto:s.scarpino@northeastern.edu">s.scarpino@northeastern.edu</a></li>
          <li>Kara Sewalk, <a href="mailto:Kara.Sewalk@childrens.harvard.edu">Kara.Sewalk@childrens.harvard.edu</a></li>
      		<li>Lin Wang, <a href="mailto:lin.wang@pasteur.fr">lin.wang@pasteur.fr</a></li>
          <li>Jessie Wu, <a href="mailto:chiehhsi.wu@gmail.com">chiehhsi.wu@gmail.com</a></li>
          <li>Bo Xu, <a href="mailto:xu-b15@mails.tsinghua.edu.cn">xu-b15@mails.tsinghua.edu.cn</a></li>
          <li>Alex Zarebski, <a href="mailto:aezarebski@gmail.com">aezarebski@gmail.com</a></li>
        </ul>
        <div class="mobile-logos">
          <img src="img/oxford-blue.svg" class="oxford-logo" alt="University of Oxford" />
          <img src="img/hm-logo-color.svg" class="hm-logo" alt="HealthMap" />
          <img src="img/harvard-logo-color.svg" class="hms-logo" alt="Harvard Medical School" />
          <img src="img/BCH_Primary_Logo.svg" class="bch-logo" alt="Boston Children's Hospital" />
          <img src="img/netsi.png" class="netsi-logo" alt="Network Science Institute at Northeastern University" />
          <img src="img/Oxford_Martin_School_Logo_color.png" class="oxford-martin-logo" alt="Oxford Martin School" />
          <img src="img/Tsinghua_University.png" class="tsinghua-logo" alt="Tsinghua University" />
          <img src="img/IHME_logo_acr_color_large.png" class="ihme-logo" alt="Institute for Health Metrics and Evaluation" />
        </div>
    	  <p class="mobile-disclaimer">All data used to produce this map are exclusively collected from publicly available sources including government reports and news media</p>
      </div>
    </div>
  </div>
  <div class="map-container">
    <div class="header">
      <h1><span>Novel Coronavirus (</span>COVID-19<span>)</span></h1>
      <div class="reported-cases">
        <div class="reported-cases-num" id="total-cases">187,746</div>
        <div class="reported-cases-label">Confirmed cases<span class="last-updated">as of <span class="last-updated-date" id="last-updated-date">2020-03-17</span></span></div>
      </div>
    </div>
    <div class="footer">
      <div class="range-slider">
    	  <div id="spread"><img src="../app/img/play.svg" width="20" height="20" alt="Play" /><span class="spread-label">Play</span></div>
        <input id="slider" type="range" value="1000" min="0" max="1000" step="1" />
        <label id="date"></label>
      </div>
      <div id="legend" class="legend">
        <div class="legend-header">Cases</div>
        <ul>
          <li style="height:80px; z-index:1">
            <span class="circle" style="width:80px; height:80px; background-color: #EDF91C; border: 1px solid #DCE80B;"></span>
            <span class="label"><span class="label-val">10,000+</span></span>
          </li>
          <li style="height:66px; z-index:2">
            <span class="circle" style="width:66px; height:66px; background-color: #FCC332; border: 1px solid #DBB221;"></span>
            <span class="label"><span class="label-val">2000</span></span>
          </li>
          <li style="height:54px; z-index:3">
            <span class="circle" style="width:54px; height:54px; background-color: #FB9533; border: 1px solid #EA8422;"></span>
            <span class="label"><span class="label-val">500</span></span>
          </li>
          <li style="height:40px; z-index:4">
            <span class="circle" style="width:40px; height:40px; background-color: #D34D60; border: 1px solid #C23C50;"></span>
            <span class="label"><span class="label-val">100</span></span>
          </li>
          <li style="height:20px; z-index:5">
            <span class="circle" style="width:20px; height:20px; background-color: #921694; border: 1px solid #810583;"></span>
            <span class="label"><span class="label-val">10</span></span>
          </li>
        </ul>
        <div class="new-cases">
          <span class="circle" style="background-color: cornflowerblue; border: 1px solid cornflowerblue;"></span>
          <span class="label"><span class="label-val">New</span></span>
        </div>
      </div>
    </div>
    <div id="map"></div>
  </div>
  <script type="text/javascript">

  var dataUrl = './ncov2019.dailies.geojson';
  //var totalsUrl = 'totals.json';
  //var dailyUrl = 'dailies.json'
  var dates = [];
  var timeControl = document.getElementById("slider");
  var timeLabel = document.getElementById("date");

  function initMap() {
      mapboxgl.accessToken = 'pk.eyJ1Ijoia2F0ZWx5bm5vYnJpZW4iLCJhIjoiY2sxa3ZjbTR4MDA2bTNjcGR4cXIwZnJidSJ9.wrkfV082TaX5P65i2L8upg';
      var map = new mapboxgl.Map({
          container: 'map',
          style: 'mapbox://styles/katelynnobrien/ck5y23wmc0aso1iqtbww5nzrr',
          center: [10, 0],
          zoom: 1,
          maxZoom: 6,
          //hash: true
      }).addControl(new mapboxgl.NavigationControl(), 'top-left');

      function filterBy(isodate) {
          var filters = ['==', 'date', isodate];
          map.setFilter('daily', filters);
          map.setFilter('totals', filters);
      }

      function setTimeControlLabel(date) {
          timeLabel.innerText = dates[date];
      };

      function buildTimeControl() {
          timeControl.setAttribute("max", dates.length - 1)
          timeControl.setAttribute("value", dates.length - 1);
          setTimeControlLabel(dates.length - 1);
      };

      timeControl.addEventListener("input", () => {
          setTimeControlLabel(timeControl.value);
          filterBy(dates[timeControl.value]);
      });

      map.on('load', function () {
          map.addSource('counts', {
              'type': 'geojson',
              'data': {
                  'type': 'FeatureCollection',
                  'features': []
              }
          });
          map.addLayer({
            'id': 'totals',
            'type': 'circle',
            'source': 'counts',
            'paint': {
                'circle-radius': ['*', ['log10', ['sqrt', ['get', 'total']]], 20],
                'circle-color': [
                    'step',
                    ['get', 'total'],
                    '#921694',
                    10,
                    '#D34D60',
                    100,
                    '#FB9533',
                    500,
                    '#FCC332',
                    2000,
                    '#EDF91C',
                ],
                // 'circle-stroke-color': [
                //     'step',
                //     ['get', 'total'],
                //     '#810583',
                //     10,
                //     '#C23C50',
                //     50,
                //     '#EA8422',
                //     250,
                //     '#EBB221',
                //     500,
                //     '#DCE80B',
                // ],
                'circle-opacity': .6,
                // 'circle-stroke-width': 1,
              }
          });
          map.addLayer({
              'id': 'daily',
              'type': 'circle',
              'source': 'counts',
              'paint': {
                  'circle-radius': ['*', ['log10', ['sqrt', ['get', 'new']]], 20],
                  'circle-color': 'cornflowerblue',
                  'circle-opacity': 0.6,
              }
          });

          // Create a popup, but don't add it to the map yet.
          var popup = new mapboxgl.Popup({
              closeButton: false,
              closeOnClick: false
          });

          // Create a popup, but don't add it to the map yet.
          var popup = new mapboxgl.Popup({
              closeButton: false,
              closeOnClick: false
          });

          map.on('mouseenter', 'totals', function (e) {
              // Change the cursor style as a UI indicator.
              map.getCanvas().style.cursor = 'pointer';

              var coordinates = e.features[0].geometry.coordinates.slice();
              var props = e.features[0].properties;
              var city = props.city ? props.city+', ' : '';
              var province = props.province ? props.province+', ' : '';
              var country = props.country ? props.country : '';
              var description =
                  '<h3 class="popup-header">' + city + province + country + '</h3>' +
                  '<div>' + '<strong>Number of Cases: </strong>' + props.total + '</div>';

              // Ensure that if the map is zoomed out such that multiple
              // copies of the feature are visible, the popup appears
              // over the copy being pointed to.
              while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
                  coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
              }

              // Populate the popup and set its coordinates
              // based on the feature found.
              popup
                  .setLngLat(coordinates)
                  .setHTML(description)
                  .addTo(map);
          });

          map.on('mouseleave', 'totals', function () {
              map.getCanvas().style.cursor = '';
              popup.remove();
          });

          // fetch(totalsUrl).then(res => res.json()).then(res => {
          //     map.getSource('cumulative').setData(res);
          // });

          fetch(dataUrl).then(res => res.json()).then(res => {
              var datesUnsorted = [];
              res.features.forEach(feature => {
                  var date = feature.properties.date;
                  if(!datesUnsorted.includes(date) && date !== '' && date !== '2020-2-18' && date !== '2020-02-2020 - 26-02-25') {
                      datesUnsorted.push(date)
                  }
              });
              dates = datesUnsorted.sort();
              buildTimeControl();
              map.getSource('counts').setData(res);
              filterBy(dates[dates.length - 1]);
          });

      });
    }
  </script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v1.8.1/mapbox-gl.css" rel="stylesheet" />

</body>
</html>
